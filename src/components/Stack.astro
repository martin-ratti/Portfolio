---
import { skills } from "../data/skills";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const skillCategories = [
    {
        title: "Frontend",
        skills: skills.frontend,
        colorClass:
            "border-violet-200 dark:border-violet-500/30 bg-violet-100/50 dark:bg-violet-500/10 text-violet-700 dark:text-violet-300 hover:bg-violet-200 dark:hover:bg-violet-500/20",
    },
    {
        title: "Backend",
        skills: skills.backend,
        colorClass:
            "border-fuchsia-200 dark:border-fuchsia-500/30 bg-fuchsia-100/50 dark:bg-fuchsia-500/10 text-fuchsia-700 dark:text-fuchsia-300 hover:bg-fuchsia-200 dark:hover:bg-fuchsia-500/20",
    },
    {
        title: t("stack.languages"),
        skills: skills.languages,
        colorClass:
            "border-cyan-200 dark:border-cyan-500/30 bg-cyan-100/50 dark:bg-cyan-500/10 text-cyan-700 dark:text-cyan-300 hover:bg-cyan-200 dark:hover:bg-cyan-500/20",
    },
    {
        title: t("stack.tools"),
        skills: skills.tools,
        colorClass:
            "border-emerald-200 dark:border-emerald-500/30 bg-emerald-100/50 dark:bg-emerald-500/10 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-200 dark:hover:bg-emerald-500/20",
    },
];
---

<section class="py-20 px-4 relative">
    <div class="max-w-6xl mx-auto">
        <h2
            class="text-3xl font-bold mb-12 text-center text-slate-900 dark:text-white"
        >
            {t("stack.title")}
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {
                skillCategories.map((category) => (
                    <div class="glass-card p-8 rounded-2xl relative overflow-hidden group">
                        <div
                            class={`absolute -right-4 -top-4 w-24 h-24 rounded-full blur-2xl opacity-20 ${category.colorClass.split(" ")[1].replace("/10", "/30")}`}
                        />

                        <h3 class="text-xl font-semibold mb-6 text-slate-800 dark:text-slate-200">
                            {category.title}
                        </h3>

                        <div class="flex flex-wrap gap-3">
                            {category.skills.map((skill) => (
                                <button
                                    class={`skill-btn px-4 py-2 rounded-lg text-sm font-medium border transition-all cursor-pointer hover:scale-105 active:scale-95 ${category.colorClass}`}
                                    data-skill={skill}
                                    aria-label={`Filtrar proyectos por ${skill}`}
                                >
                                    {skill}
                                </button>
                            ))}
                        </div>
                    </div>
                ))
            }
        </div>
    </div>
</section>

<script>
    // @ts-nocheck
    const buttons = document.querySelectorAll(".skill-btn");
    let activeSkill = null;

    buttons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent document click from firing immediately
            const skill = btn.getAttribute("data-skill");

            // Toggle Logic
            if (activeSkill === skill) {
                // Deselect
                activeSkill = null;
                buttons.forEach((b) => {
                    b.classList.remove(
                        "ring-2",
                        "ring-offset-2",
                        "ring-violet-500",
                        "scale-105",
                    );
                    b.classList.add("opacity-100");
                    b.classList.remove("opacity-50");
                });
            } else {
                // Select
                activeSkill = skill;
                buttons.forEach((b) => {
                    if (b.getAttribute("data-skill") === skill) {
                        b.classList.add(
                            "ring-2",
                            "ring-offset-2",
                            "ring-violet-500",
                            "scale-105",
                        );
                        b.classList.remove("opacity-50", "opacity-100");
                    } else {
                        b.classList.remove(
                            "ring-2",
                            "ring-offset-2",
                            "ring-violet-500",
                            "scale-105",
                        );
                        b.classList.add("opacity-50"); // Dim others
                        b.classList.remove("opacity-100");
                    }
                });
            }

            // Dispatch event
            window.dispatchEvent(
                new CustomEvent("filter-projects", {
                    detail: { skill: activeSkill },
                }),
            );

            // Scroll only on selection
            if (activeSkill) {
                const projectsSection = document.getElementById("proyectos");
                if (projectsSection) {
                    projectsSection.scrollIntoView({ behavior: "smooth" });
                }
            }
        });
    });

    // Click outside to deselect
    document.addEventListener("click", (e) => {
        if (!e.target.closest(".skill-btn") && activeSkill) {
            activeSkill = null;
            buttons.forEach((b) => {
                b.classList.remove(
                    "ring-2",
                    "ring-offset-2",
                    "ring-violet-500",
                    "scale-105",
                );
                b.classList.add("opacity-100");
                b.classList.remove("opacity-50");
            });
            window.dispatchEvent(
                new CustomEvent("filter-projects", {
                    detail: { skill: null },
                }),
            );
        }
    });
</script>
